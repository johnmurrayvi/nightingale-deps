# The Microsoft C Runtime source code to which this document refers is available
# directly from Microsoft Corporation, under a separate license.
# Please ensure that if you are using that source code, you have appropriate
# rights to use it.  By providing you access to this file, Mozilla Corporation
# and its affiliates do not purport to grant any rights in that source code. 
# Binaries are available under separate licenses at 
# http://www.microsoft.com/downloads/details.aspx?familyid=200b2fd9-ae1a-4a14-984d-389c36f85647&displaylang=en
diff -re crt/src/crt0.c crt-sp1/src/crt0.c
273a
#endif
.
272a
#ifdef MOZ_MEMORY
	/*
	 * this used to happen in _mtinit, but we need it before malloc
	 */
	_init_pointers();       /* initialize global function pointers */

        if ( malloc_init_hard() )           /* initialize heap */
#else
.
101a
#ifdef MOZ_MEMORY
extern BOOL malloc_init_hard(void);
#endif
.
diff -re crt/src/crt0dat.c crt-sp1/src/crt0dat.c
789a
#endif
.
788a
#ifndef MOZ_MEMORY
.
778a
#endif
.
777a
#ifndef MOZ_MEMORY
.
diff -re crt/src/crtdbg.h crt-sp1/src/crtdbg.h
1150c
#if (!defined (_M_CEE_PURE) && !defined(MOZ_MEMORY))
.
1137c
#if (!defined(_DEBUG) || defined(MOZ_MEMORY))
.
1126a
#endif
.
1054a
#ifndef MOZ_MEMORY
.
1009a
#endif
.
1006a
#ifndef MOZ_MEMORY
.
928a
#endif  /* MOZ_MEMORY */
.
924a
#ifndef MOZ_MEMORY
.
922a
#endif /* MOZ_MEMORY */ 
.
920a
#ifndef MOZ_MEMORY
.
801a
#endif /* MOZ_MEMORY */
.
688a
#ifndef MOZ_MEMORY
.
624c
#if (defined(_CRTDBG_MAP_ALLOC) && !defined(MOZ_MEMORY))
.
616a
#endif
.
603a
#ifndef MOZ_MEMORY
.
474a
#endif
.
471a
#ifndef MOZ_MEMORY
.
340a
#ifdef MOZ_MEMORY
// Defined in dbgint.h, but tc-Int doesn't include that header
#define _free_base free
#define _malloc_base malloc
#endif

.
330a
#ifdef _DEBUG
.
329c
#endif /* not defined _DEBUG */
.
322a
#endif
.
318a
#if (!defined(MOZ_MEMORY) && !defined(MOZ_MEMORY_DEBUG))
.
314a
#endif
.
309a
#if (!defined(MOZ_MEMORY) && !defined(MOZ_MEMORY_DEBUG))
.
308a
#endif
.
302a
#if (!defined(MOZ_MEMORY) && !defined(MOZ_MEMORY_DEBUG))
.
300a
#endif /* MOZ_MEMORY_DEBUG */

.
204a
#ifndef MOZ_MEMORY_DEBUG
.
191c
#if (!(defined(_DEBUG)) || defined(MOZ_MEMORY))
.
diff -re crt/src/crtexe.c crt-sp1/src/crtexe.c
334c
#endif
.
332a
#ifndef MOZ_MEMORY
.
diff -re crt/src/crtheap.c crt-sp1/src/crtheap.c
61a
#endif
.
60a
#ifdef MOZ_MEMORY
    pv = calloc(count, size);
#else
.
58a
#endif
.
57a
#ifndef MOZ_MEMORY
.
diff -re crt/src/crtlib.c crt-sp1/src/crtlib.c
787a
#endif
.
780a
#ifndef MOZ_MEMORY
.
416a
#endif
.
415a
#ifndef MOZ_MEMORY
.
399c
#endif  /* _DEBUG && MOZ_MEMORY */

#ifdef MOZ_MEMORY
		malloc_shutdown();
#endif
.
391c
#if defined(_DEBUG) && !defined(MOZ_MEMORY)
// XXX: should do jemalloc's memory_statistics call here? -preed
.
359a
#endif
.
358a
#ifndef MOZ_MEMORY
.
340a
#endif
.
339a
#ifndef MOZ_MEMORY
.
310a
#endif
.
309a
#ifndef MOZ_MEMORY
.
300a
#endif
.
299a
#ifndef MOZ_MEMORY
.
287a
#endif
.
286a
#ifdef MOZ_MEMORY
            /*
             * this used to happen in _mtinit, but we need it before malloc
             */
            _init_pointers();       /* initialize global function pointers */

            if ( malloc_init_hard() )   /* initialize heap */
#else
.
43a
#ifdef MOZ_MEMORY
extern BOOL malloc_init_hard(void);
extern void malloc_shutdown(void);
#endif

.
diff -re crt/src/dbgint.h crt-sp1/src/dbgint.h
208a
#endif
.
205a
#ifndef MOZ_MEMORY
.
162a
#endif
.
159a
#ifndef MOZ_MEMORY
.
154a
#endif /* MOZ_MEMORY */
.
137a
#ifndef MOZ_MEMORY
.
126,128c
#ifdef _DEBUG
.
124a
#endif /* mozilla memory and not debug */
#endif /* not debug and jemalloc */
.
108a
#if (!defined(MOZ_MEMORY) || (defined(MOZ_MEMORY) && !defined(MOZ_MEMORY_DEBUG)))
.
107a
#endif /* mozilla memory and not debug */
.
100a
#if (defined(MOZ_MEMORY) && !defined(_DEBUG))
.
88c
#if defined (_SYSCRT) || defined (MRTDLL) || defined (_M_CEE_PURE) || defined(MOZ_MEMORY)
.
67,68c
#if (!(defined(_DEBUG)) || defined(MOZ_MEMORY))
/* Following comment is misleading; debug is off *or* we're jemalloc. */
.
diff -re crt/src/delete.cpp crt-sp1/src/delete.cpp
11c
#if (!defined(_DEBUG) || defined(MOZ_MEMORY))
.
diff -re crt/src/dllcrt0.c crt-sp1/src/dllcrt0.c
237a
#endif
.
235a
#ifndef MOZ_MEMORY
.
183a
#endif
.
182a
#ifndef MOZ_MEMORY
.
173a
#endif
.
172a
#ifndef MOZ_MEMORY
.
158a
#endif
.
157a
#ifndef MOZ_MEMORY
.
154a
#endif
.
152a
#ifndef MOZ_MEMORY
.
diff -re crt/src/fullpath.c crt-sp1/src/fullpath.c
121c
#if (defined(_DEBUG) && !defined(MOZ_MEMORY))
.
diff -re crt/src/getcwd.c crt-sp1/src/getcwd.c
292c
#if (defined(_DEBUG) && !defined(MOZ_MEMORY))
.
diff -re crt/src/getenv.c crt-sp1/src/getenv.c
359c
#if (defined(_DEBUG) && !defined(MOZ_MEMORY))
.
diff -re crt/src/intel/mozcrt19.def crt-sp1/src/intel/mozcrt19.def
1408a
    _malloc_crt
    _calloc_crt
    _realloc_crt
.
1208d
723,724d
669a
    posix_memalign
.
643a
    memalign
.
500a
    malloc_usable_size
    jemalloc_stats
.
336,341d
324d
313,314d
81d
15,16d
9c
LIBRARY MOZCRT19
.
diff -re crt/src/intel/mozcrt19d.def crt-sp1/src/intel/mozcrt19d.def
1426a
    _malloc_crt
    _calloc_crt
    _realloc_crt
    _calloc_dbg
    _realloc_dbg
.
1255d
1225d
732,733d
678a
    posix_memalign
.
652a
    memalign
.
508c
    _malloc_dbg
    malloc_usable_size
    jemalloc_stats
.
343,348d
331d
320,321d
260c
    _free_dbg
.
88,95d
81d
15,16d
9c
LIBRARY MOZCRT19D
.
diff -re crt/src/makefile crt-sp1/src/makefile
1237a
!endif
.
1236a
!if "$(MOZ_MEMORY)"!="1"
.
1233a
!if "$(MOZ_MEMORY)"!="1"
OBJS_WITH_EXPORTS_DLL_RAW= \
        $(OBJS_WITH_EXPORTS_DLL_RAW) \
        $(OBJDIR_DLL_RAW)\handler.obj \
        $(OBJDIR_DLL_RAW)\setnewh.obj \
        $(OBJDIR_DLL_RAW)\new_mode.obj
!endif
.
1228,1230d
1033c
xdll_ :: $(OBJROOT) $(OBJCPUDIR) $(OBJDIR_DLL_DBG) \
	$(OBJDIR_DLL_DBG)\$(PURE_OBJ_DIR) $(OBJDIR_DLL_DBG)\$(CLR_OBJ_DIR) \
    $(OBJDIR_DLL_DBG)\$(CPP_OBJ_DIR) $(RELDIR_CPU) $(PDBDIR_CPU_DLL) \
    $(MAKE_DIRS_DLL)
.
754c
dll_ :: $(OBJROOT) $(OBJCPUDIR) $(OBJDIR_DLL) $(OBJDIR_DLL)\$(PURE_OBJ_DIR) \
   	$(OBJDIR_DLL)\$(CPP_OBJ_DIR) \
   	$(RELDIR_CPU) $(PDBDIR_CPU_DLL) $(MAKE_DIRS_DLL)
.
334c
CC_OPTS_BASE=-c -nologo -Zlp8 -W3 -GFy -DWIND32
!if "$(MOZ_MEMORY)" != "1"
CC_OPTS_BASE=$(CC_OPTS_BASE) -WX
!endif
.
307,309c
LINKER=link
LINKLIB=link -lib
LINKIMPLIB=link -lib
.
302,304c
LINKER=link -nologo
LINKLIB=link -lib -nologo
LINKIMPLIB=link -lib -nologo
.
209a
!endif
.
208a
!if "$(MOZ_MEMORY)" != "1"
.
21,41c
RETAIL_DLL_NAME=MOZCRT19
RETAIL_LIB_NAME=mozcrt19
RETAIL_DLLCPP_NAME=mozcrt19_p
RETAIL_LIBCPP_NAME=mozcrt19_p
RETAIL_DLLMIXED_NAME=mozcrt19_m
RETAIL_LIBMIXED_NAME=mozcrt19_m
RETAIL_LIBPURE_NAME=mozcrt19_u
RETAIL_PT_LIBMIXED_NAME=mozcrt19_pm
RETAIL_PT_LIBPURE_NAME=mozcrt19_pu
DEBUG_DLL_NAME=mozcrt19d
DEBUG_LIB_NAME=mozcrt19d
DEBUG_DLLCPP_NAME=mozcrt19d_p
DEBUG_LIBCPP_NAME=mozcrt19d_p
DEBUG_DLLMIXED_NAME=mozcrt19d_m
DEBUG_LIBMIXED_NAME=mozcrt19d_m
DEBUG_LIBPURE_NAME=mozcrt19d_u
DEBUG_PT_LIBMIXED_NAME=mozcrt19d_pm
DEBUG_PT_LIBPURE_NAME=mozcrt19d_pu
RC_NAME=mozcrt19
RCCPP_NAME=mozcrt19_p
RCMIXED_NAME=mozcrt19_m
.
diff -re crt/src/makefile.inc crt-sp1/src/makefile.inc
1526a
!endif
.
1524a
!if "$(MOZ_MEMORY)"=="1" && "$(BLD_DBG)"=="1"
$(OBJDIR)\eh.lib: $(CPUDIR)\dll_lib\eh.lib
        copy $(CPUDIR)\dll_lib\eh.lib $@
!else
.
1295a
!if "$(MOZ_MEMORY)" == "1"
        $(PURE_OBJDIR)\jemalloc.obj \
!endif
.
1251a
!if "$(MOZ_MEMORY)" == "1"
        $(CLR_OBJDIR)\jemalloc.obj \
!endif
.
753a
!endif
.
751a
!if "$(MOZ_MEMORY)"!="1"
.
621a
!endif
.
619a
!if "$(MOZ_MEMORY)"!="1"
.
618a
!endif
.
617a
!if "$(MOZ_MEMORY)" != "1"
.
402a
!endif
.
401a
!if "$(MOZ_MEMORY)" != "1"
.
353a
!else
        $(OBJDIR)\jemalloc.obj \
!endif
.
341a
!if "$(MOZ_MEMORY)" != "1"
.
335a
!endif
.
333a
!if "$(MOZ_MEMORY)" != "1"
.
330a
!endif
.
328a
!if "$(MOZ_MEMORY)" != "1"
.
327a
!endif
.
326a
!if "$(MOZ_MEMORY)" != "1"
.
323a
!endif
.
322a
!if "$(MOZ_MEMORY)" != "1"
.
320a
!endif
.
319a
!if "$(MOZ_MEMORY)" != "1"
.
diff -re crt/src/makefile.sub crt-sp1/src/makefile.sub
103c
LIB=link -lib -nologo
.
70a
!endif
.
68a
!if "$(MOZ_MEMORY)"=="1"
CFLAGS=$(CFLAGS) -O2
!else
.
56c
CFLAGS=-D_CRT_NOFORCE_MANIFEST -D_STL_NOFORCE_MANIFEST $(CFLAGS) $(MOZ_CFLAGS)
.
54a
!if "$(MOZ_MEMORY)"=="1"
# I'm in ur crt, munging your cflags...
MOZ_CFLAGS=-DMOZ_MEMORY=1 -DMOZ_MEMORY_WINDOWS=1
!if "$(MOZ_DEBUG)" == "1"
MOZ_CFLAGS=$(MOZ_CFLAGS) -DMOZ_MEMORY_DEBUG=1 -DMOZ_DEBUG=1
!endif
!else
MOZ_CFLAGS=
!endif
.
diff -re crt/src/malloc.h crt-sp1/src/malloc.h
189a
#endif /* MOZ_MEMORY */
.
177a

#ifndef MOZ_MEMORY
.
161d
83a
#endif  /* MOZ_MEMORY */
.
70a
#ifndef MOZ_MEMORY
.
diff -re crt/src/mlock.c crt-sp1/src/mlock.c
274c
#endif
.
262a
#ifndef MOZ_MEMORY
.
diff -re crt/src/mozcrt19.rc crt-sp1/src/mozcrt19.rc
41c
            VALUE "ProductName", "Mozilla Custom C Runtime"
.
39c
            VALUE "OriginalFilename", "MOZCRT19.DLL"
.
37c
            VALUE "OriginalFilename", "MOZCRT19D.DLL"
.
33c
            VALUE "InternalName", "MOZCRT19.DLL"
.
31c
            VALUE "InternalName", "MOZCRT19D.DLL"
.
27c
            VALUE "CompanyName", "Mozilla Foundation"
.
diff -re crt/src/mozcrt19_m.def crt-sp1/src/mozcrt19_m.def
8c
LIBRARY MOZCRT19_M
.
diff -re crt/src/mozcrt19_m.rc crt-sp1/src/mozcrt19_m.rc
41c
            VALUE "ProductName", "Mozilla Custom C Runtime"
.
39c
            VALUE "OriginalFilename", "MOZCRT19_M.DLL"
.
37c
            VALUE "OriginalFilename", "MOZCRT19_M.DLL"
.
33c
            VALUE "InternalName", "MOZCRT19_M.DLL"
.
31c
            VALUE "InternalName", "MOZCRT19D_M.DLL"
.
27c
            VALUE "CompanyName", "Mozilla Foundation"
.
diff -re crt/src/mozcrt19_p.def crt-sp1/src/mozcrt19_p.def
8c
LIBRARY MOZCRT19_P
.
diff -re crt/src/mozcrt19_p.rc crt-sp1/src/mozcrt19_p.rc
41c
            VALUE "ProductName", "Mozilla Custom C Runtime"
.
39c
            VALUE "OriginalFilename", "MOZCRT19_P.DLL"
.
37c
            VALUE "OriginalFilename", "MOZCRT19D_P.DLL"
.
33c
            VALUE "InternalName", "MOZCRT19_P.DLL"
.
31c
            VALUE "InternalName", "MOZCRT19D_P.DLL"
.
27c
            VALUE "CompanyName", "Mozilla Foundation"
.
diff -re crt/src/mozcrt19_u.def crt-sp1/src/mozcrt19_u.def
8c
LIBRARY MOZCRT19_M
.
diff -re crt/src/mozcrt19d_m.def crt-sp1/src/mozcrt19d_m.def
8c
LIBRARY MOZCRT19D_M
.
diff -re crt/src/mozcrt19d_p.def crt-sp1/src/mozcrt19d_p.def
8c
LIBRARY MOZCRT19D_P
.
diff -re crt/src/mozcrt19d_u.def crt-sp1/src/mozcrt19d_u.def
8c
LIBRARY MOZCRT19D_M
.
diff -re crt/src/new.cpp crt-sp1/src/new.cpp
60a
#endif
.
59a
#ifndef MOZ_MEMORY
.
54a
#endif
.
51a
#ifndef MOZ_MEMORY
.
37a
#endif
.
36a
#ifndef MOZ_MEMORY
.
diff -re crt/src/nothrownew.cpp crt-sp1/src/nothrownew.cpp
71a
#endif
.
56a
#ifndef MOZ_MEMORY
.
37a
#endif
.
31a
#ifdef MOZ_MEMORY
        break;
#else

.
diff -re crt/src/stdthrow.cpp crt-sp1/src/stdthrow.cpp
24c
            //::_CrtDbgBreak();
            _CrtDbgBreak();
.
diff -re crt/src/strdup.c crt-sp1/src/strdup.c
74c
#if (defined(_DEBUG) && !defined(MOZ_MEMORY))
.
diff -re crt/src/tempnam.c crt-sp1/src/tempnam.c
142c
#if (defined(_DEBUG) && !defined(MOZ_MEMORY))
.
diff -re crt/src/tidtable.c crt-sp1/src/tidtable.c
393a
#endif
.
392a
#ifndef MOZ_MEMORY
.
diff -re crt/src/wcsdup.c crt-sp1/src/wcsdup.c
76c
#if (defined(_DEBUG) && !defined(MOZ_MEMORY))
.
diff -re crt/src/winheap.h crt-sp1/src/winheap.h
175a
#endif
.
172a
#ifndef MOZ_MEMORY
.
170a
#endif
.
169a
#ifndef MOZ_MEMORY
.
diff -re crt/src/xdebug crt-sp1/src/xdebug
22c
 #if (defined(_DEBUG) && !defined(MOZ_MEMORY))
.
diff -re crt/src/xdebug.cpp crt-sp1/src/xdebug.cpp
3c
 #if (defined(_DEBUG) && !defined(MOZ_MEMORY))
.
diff -re crt/src/xlocale crt-sp1/src/xlocale
137c
 #if (defined(_DEBUG) && !defined(MOZ_MEMORY))
.
